@page
@model StudentListModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using System.Text.Json
@using StudentFilesFrontend.Models
<style>
    .modal-body .col-6, .modal-body .col-12 {
        padding: 6px;
    }

    .modal-body small {
        font-size: 0.75rem;
    }

    .modal-body .fw-semibold {
        font-size: 0.9rem;
    }
</style>


<!-- 📋 PAGE CONTENT -->
<div class="container mt-4">
    <h2 class="mb-4">📋 Student Files</h2>

    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addStudentModal">
        <i class="bi bi-plus-circle"></i> Add Student
    </button>
    <button class="btn btn-danger mb-3" data-bs-toggle="modal" data-bs-target="#pdfFilterModal">
        <i class="bi bi-file-earmark-pdf"></i> Generate PDF
    </button>

    @if (Model.Students == null || Model.Students.Count == 0)
    {
        <div class="alert alert-info">No student records found.</div>
    }
    else
    {
        <div class="table-responsive">
            <table id="studentTable" class="table table-hover table-bordered align-middle shadow-sm">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Grade</th>
                        <th>Section</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in Model.Students)
                    {
                        var json = JsonSerializer.Serialize(s, new JsonSerializerOptions { PropertyNamingPolicy = null });

                        <tr class="student-row" data-student='@Html.Raw(json)'>
                            <td>@s.StudentID</td>
                            <td>@s.Studentname</td>
                            <td>@s.Gradelevel</td>
                            <td>@s.Section</td>
                            <td>
                                <span class="badge @(s.Status?.ToLower() == "complete" ? "bg-success" : "bg-warning")">
                                    @s.Status
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick='editStudent(@Html.Raw(json))'>Edit</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- 🎓 Student Details Modal -->
<div class="modal fade" id="studentModal" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 1000px;">
        <div class="modal-content shadow-lg rounded-4 border-0">
            <div class="modal-header bg-primary text-white rounded-top-4">
                <h5 class="modal-title d-flex align-items-center gap-2" id="studentModalLabel">
                    <i class="bi bi-person-lines-fill fs-4"></i> Student Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">

                    <!-- Name -->
                    <div class="col-12">
                        <label class="text-uppercase text-muted small">Name</label>
                        <div class="fw-bold" id="mStudentname"></div>
                    </div>

                    <!-- 3-column fields -->
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">ID</label>
                        <div class="fw-bold" id="mStudentID"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">Grade</label>
                        <div class="fw-bold" id="mGradelevel"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">Section</label>
                        <div class="fw-bold" id="mSection"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">Status</label>
                        <div class="fw-bold" id="mStatus"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">LRN</label>
                        <div class="fw-bold" id="mLrn"></div>
                    </div>

                    <!-- Former School -->
                    <div class="col-12">
                        <label class="text-uppercase text-muted small">Former School</label>
                        <div class="fw-bold" id="mFormerschool"></div>
                    </div>

                    <!-- Remaining Documents -->
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">Location</label>
                        <div class="fw-bold" id="mLocation"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">PSA</label>
                        <div class="fw-bold" id="mPSA"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">Card</label>
                        <div class="fw-bold" id="mCard"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">Enrollment Form</label>
                        <div class="fw-bold" id="mEnrollmentform"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">Passport Picture</label>
                        <div class="fw-bold" id="mPassportpicture"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">Academic Honors</label>
                        <div class="fw-bold" id="mAcademichonors"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">Indigency</label>
                        <div class="fw-bold" id="mIndegency"></div>
                    </div>
                    <div class="col-4">
                        <label class="text-uppercase text-muted small">Form 137</label>
                        <div class="fw-bold" id="mForm137"></div>
                    </div>

                    <!-- HIDDEN FIELDS -->
                    <div class="col-4 visually-hidden">
                        <label class="text-uppercase text-muted small">School Year</label>
                        <div class="fw-bold" id="mSchoolyearName"></div>
                    </div>
                    <div class="col-4 visually-hidden">
                        <label class="text-uppercase text-muted small">Campus</label>
                        <div class="fw-bold" id="mCampusName"></div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>


<!-- 🔹 Update STUDENT MODAL -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-3">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editStudentModalLabel">Edit Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editStudentForm">
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">StudentID</label>
                            <input name="StudentID" id="edit_StudentID" class="form-control" readonly />
                        </div>
                        @foreach (var field in new[] {
                                                "Studentname", "Gradelevel", "Section", "Remarks", "Status", "Lrn",
                                                "Formerschool", "Location", "PSA", "Card", "Enrollmentform", "Passportpicture",
                                                "Academichonors", "Indegency", "Form137" })
                        {
                            <div class="col-md-6">
                                <label class="form-label">@field</label>
                                <input name="@field" id="edit_@field" class="form-control" />
                            </div>
                        }

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ➕ ADD STUDENT MODAL -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="addStudentModalLabel">Add New Student</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="addStudentForm" method="post" autocomplete="off">
                <div class="modal-body">
                    <div id="apiError" class="alert alert-danger d-none" role="alert"></div>
                    <div class="row g-3">

                        <!-- Student ID -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Student ID <span class="text-danger">*</span></label>
                            <input name="StudentID" class="form-control" pattern="^[0-9\-]+$" title="Only numbers and dashes allowed" required />
                        </div>

                        <!-- Student Name -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Student Name <span class="text-danger">*</span></label>
                            <input name="StudentName" class="form-control" required />
                        </div>

                        <!-- Grade Level -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Grade Level <span class="text-danger">*</span></label>
                            <input name="GradeLevel" class="form-control" required />
                        </div>

                        <!-- Section -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Section</label>
                            <input name="Section" class="form-control" />
                        </div>

                        <!-- Remarks -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Remarks</label>
                            <input name="Remarks" class="form-control" />
                        </div>

                        <!-- Status -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Status</label>
                            <input name="Status" class="form-control" />
                        </div>

                        <!-- LRN -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">LRN</label>
                            <input name="LRN" class="form-control" />
                        </div>

                        <!-- Former School -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Former School</label>
                            <input name="FormerSchool" class="form-control" />
                        </div>

                        <!-- Location -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Location</label>
                            <input name="Location" class="form-control" />
                        </div>

                        <!-- School Year (readonly display) -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">School Year</label>
                            <input class="form-control bg-light" value="@Model.Schoolyear" disabled />
                            <input type="hidden" name="SchoolyearName" value="@Model.Schoolyear" />
                        </div>

                        <!-- Campus Name (readonly display) -->
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Campus Name</label>
                            <input class="form-control bg-light" value="@Model.CampusName" disabled />
                            <input type="hidden" name="CampusName" value="@Model.CampusName" />
                        </div>

                        <!-- Document dropdowns -->
                        @foreach (var doc in new[] { "PSA", "Card", "EnrollmentForm", "PassportPicture", "AcademicHonors", "Indegency", "Form137" })
                        {
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">@doc</label>
                                <select name="@doc" class="form-select">
                                    <option value="Not Submitted">Not Submitted</option>
                                    <option value="Submitted P.C">Submitted P.C</option>
                                    <option value="Submitted Original">Submitted Original</option>
                                </select>
                            </div>
                        }

                    </div> <!-- end row -->
                </div> <!-- end modal-body -->

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- 📜 SCRIPTS -->
@section Scripts {
    <script>
        // ✅ Show Student Modal with values
        function showStudentModal(student) {
            document.getElementById('mStudentID').textContent = student.StudentID || '';
            document.getElementById('mStudentname').textContent = student.Studentname || '';
            document.getElementById('mGradelevel').textContent = student.Gradelevel || '';
            document.getElementById('mSection').textContent = student.Section || '';
            document.getElementById('mStatus').textContent = student.Status || '';
            document.getElementById('mLrn').textContent = student.Lrn || '';
            document.getElementById('mFormerschool').textContent = student.Formerschool || '';
            document.getElementById('mLocation').textContent = student.Location || '';
            document.getElementById('mPSA').textContent = student.PSA || '';
            document.getElementById('mCard').textContent = student.Card || '';
            document.getElementById('mEnrollmentform').textContent = student.Enrollmentform || '';
            document.getElementById('mPassportpicture').textContent = student.Passportpicture || '';
            document.getElementById('mAcademichonors').textContent = student.Academichonors || '';
            document.getElementById('mIndegency').textContent = student.Indegency || '';
            document.getElementById('mForm137').textContent = student.Form137 || '';
             document.getElementById('mSchoolyearName').textContent = student.SchoolyearName || '';
            document.getElementById('mCampusName').textContent = student.CampusName || '';
            const modal = new bootstrap.Modal(document.getElementById('studentModal'));
            modal.show();
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("addStudentForm");
            const apiError = document.getElementById("apiError");

            if (form) {
                form.addEventListener("submit", async function (e) {
                    e.preventDefault();
                    apiError.classList.add("d-none");
                    const studentData = Object.fromEntries(new FormData(form).entries());
                    const params = new URLSearchParams(studentData).toString();

                    try {
                        const response = await fetch(`https://localhost:7116/api/Studentfiles/add?${params}`, {
                            method: "POST"
                        });

                        if (response.ok) {
                            form.reset();
                            const modal = bootstrap.Modal.getInstance(document.getElementById("addStudentModal"));
                            if (modal) modal.hide();
                            location.reload();
                        } else {
                            const errorText = await response.text();
                            apiError.textContent = errorText || "❌ Failed to add student.";
                            apiError.classList.remove("d-none");
                        }
                    } catch (error) {
                        apiError.textContent = "❌ Network error: " + error.message;
                        apiError.classList.remove("d-none");
                    }
                });
            }

            document.querySelectorAll(".student-row").forEach(row => {
                row.addEventListener("click", (e) => {
                    if (e.target.closest("button")) return;
                    const student = JSON.parse(row.getAttribute("data-student"));
                    showStudentModal(student);
                });
            });
        });
    </script>

    <script>
        function editStudent(student) {
            const fields = [
                "StudentID", "Studentname", "Gradelevel", "Section", "Remarks", "Status", "Lrn",
                "Formerschool", "Location", "PSA", "Card", "Enrollmentform", "Passportpicture",
                "Academichonors", "Indegency", "Form137", "SchoolyearName", "CampusName"
            ];

            fields.forEach(field => {
                const input = document.getElementById("edit_" + field);
                if (input) input.value = student[field] || '';
            });

            const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
            modal.show();
        }

        document.getElementById("editStudentForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const studentData = Object.fromEntries(formData.entries());

            try {
                const query = new URLSearchParams(studentData).toString();

                const response = await fetch(`https://localhost:7116/api/Studentfiles/update?${query}`, {
                    method: "PUT"
                });

                if (response.ok) {
                    alert("✅ Student updated successfully!");
                    bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                    location.reload(); // refresh list
                } else {
                    const error = await response.text();
                    alert("❌ Update failed:\n" + error);
                }
            } catch (err) {
                alert("❌ Network error:\n" + err.message);
            }
        });
    </script>
}

    <!-- ✅ Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />

